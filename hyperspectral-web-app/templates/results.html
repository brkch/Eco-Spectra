<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Results Analysis</title>
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <!-- Chart.js library for bar plots -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- Lucide icons for navbar -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    /* === EXTRACTED NAVBAR STYLES === */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #1a1a1a;
    }
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #e2e8f0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }
    .nav-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 4rem;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .logo-icon i {
      width: 4rem;
      height: 2rem;
    }
    .logo-text {
      font-size: 1.25rem;
      font-weight: bold;
      color: #1e293b;
    }
    .nav-menu {
      display: flex;
      align-items: center;
      gap: 2rem;
    }
    .nav-link {
      color: #475569;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s;
    }
    .nav-link:hover {
      color: #2563eb;
    }
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      padding: 0.5rem;
      color: #475569;
      cursor: pointer;
    }
    .mobile-menu {
      display: none;
      padding: 1rem 0;
      border-top: 1px solid #e2e8f0;
    }
    .mobile-menu-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .mobile-nav-link {
      color: #475569;
      text-decoration: none;
      font-weight: 500;
    }
    /* Button Styles */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #2563eb;
      color: white;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    /* === MODAL STYLES === */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 0;
      border: none;
      border-radius: 12px;
      width: 90%;
      max-width: 1000px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.5em;
      font-weight: 600;
    }
    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.3s;
    }
    .close:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    .modal-body {
      padding: 30px;
      max-height: calc(90vh - 120px);
      overflow-y: auto;
    }
    .detail-section {
      margin-bottom: 25px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      border-left: 4px solid #2563eb;
    }
    .detail-section h3 {
      color: #2563eb;
      margin: 0 0 15px 0;
      font-size: 1.2em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    .detail-item {
      background: white;
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }
    .detail-label {
      font-weight: 600;
      color: #374151;
      font-size: 0.9em;
      margin-bottom: 4px;
    }
    .detail-value {
      color: #1f2937;
      font-size: 1em;
    }
    .highlight-value {
      color: #2563eb;
      font-weight: 600;
    }
    .performance-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
    }
    .metric-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 2px solid #e2e8f0;
    }
    .metric-value {
      font-size: 1.8em;
      font-weight: bold;
      color: #2563eb;
      margin-bottom: 5px;
    }
    .metric-label {
      font-size: 0.9em;
      color: #6b7280;
      font-weight: 500;
    }
    /* === RESULTS PAGE STYLES === */
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0;
      padding: 80px 20px 20px;
      box-sizing: border-box;
    }
    .results-grid {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 20px 0;
      width: 100%;
    }
    .result-card {
      border: 2px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      background: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 100%;
      box-sizing: border-box;
    }
    .result-card h3 {
      margin: 0 0 15px 0;
      font-size: 1.2em;
      color: #333;
      text-align: center;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .summary-compact {
      font-size: 1em;
      margin: 0 0 20px 0;
      text-align: center;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      position: relative;
    }
    .details-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      background: #2563eb;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .details-btn:hover {
      background: #1d4ed8;
    }

    /* NEW LAYOUT STYLES */
    .content-layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }

    /* Images row - 3 images in one line */
    .images-row {
      display: flex;
      gap: 15px;
      width: 100%;
    }

    .img-label {
      font-size: 0.9em;
      margin-top: 8px;
      color: #666;
      font-weight: bold;
    }

    .charts-row {
      display: flex;
      gap: 20px;
      width: 100%;
    }

    .chart-container {
      flex: 1;
      height: 400px;
    }

    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .no-polymer {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px;
    }
    .no-polymer img {
      width: 100%;
      max-width: 400px;
      height: 300px;
      object-fit: cover;
      border-radius: 8px;
      margin: 20px 0;
    }
    .results-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 25px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
    }
    .results-summary {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 20px 0;
      font-size: 1em;
    }
    .summary-stat {
      background: rgba(255,255,255,0.2);
      padding: 12px 20px;
      border-radius: 25px;
    }
    .back-link {
      display: block;
      text-align: center;
      margin: 40px auto;
      padding: 15px 40px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 30px;
      width: fit-content;
      font-weight: bold;
      font-size: 1.1em;
      transition: background 0.3s;
    }
    .back-link:hover {
      background: #0056b3;
    }
    .img-container {
      flex: 1;
      text-align: center;
    }

    .img-container img {
      width: 100%;
      height: 75%;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ddd;
    }
     @media (max-width: 768px) {
      .nav-menu {
        display: none;
      }
      .mobile-menu-btn {
        display: block;
      }
      .mobile-menu.show {
        display: block;
      }
      .container {
        padding-top: 100px;
        padding-left: 15px;
        padding-right: 15px;
      }
      .images-row {
        flex-direction: column;
        gap: 15px;
      }
      .charts-row {
        flex-direction: column;
        gap: 20px;
      }
      .chart-container {
        height: 300px;
      }

      .img-container img {
        height: 75%;
      }
      .results-summary {
        flex-direction: column;
        gap: 15px;
      }
      .modal-content {
        width: 95%;
        margin: 5% auto;
      }
      .modal-body {
        padding: 20px;
      }
      .detail-grid {
        grid-template-columns: 1fr;
      }
      .performance-metrics {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 1200px) {
      .charts-row {
        flex-direction: column;
        gap: 20px;
      }
      .chart-container {
        height: 300px;
      }

    }
    @media (max-width: 480px) {
      .result-card {
        padding: 15px;
      }
      .img-container img {
        height: 75%;
      }
      .chart-container {
        height: 200px;
      }

      .performance-metrics {
        grid-template-columns: 1fr;
      }
      .details-btn {
        position: static;
        margin-top: 10px;
        align-self: center;
      }
      .summary-compact {
        position: relative;
        padding-top: 15px;
      }
    }
    .Eco{
      color:darkcyan;
    }

  .result-card {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
  margin: 20px 0;
  transition: transform 0.3s ease;
}

.result-card:hover {
  transform: translateY(-4px);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
}

.file-name {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.2rem;
  color: #333;
  margin: 0;
}

.download-btn {
  background: linear-gradient(to right, #5f4b8b, #3b3f9c); /* Deep violet to indigo */
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 25px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 14px rgba(63, 61, 123, 0.3);
  transition: all 0.3s ease;
  margin-bottom: 10px;
}

.download-btn:hover {
  background: linear-gradient(to right, #3b3f9c, #5f4b8b); /* Reverse on hover */
  box-shadow: 0 6px 20px rgba(63, 61, 123, 0.5);
  transform: translateY(-2px);
}
.button-wrapper {
  display: flex;
  justify-content: center;
  margin: 30px 0;
}

.downloads-btn {
  background: linear-gradient(to right, #5f4b8b, #3b3f9c); /* Violet to Indigo */
  color: white;
  border: none;
  padding: 14px 26px; /* Slightly bigger */
  border-radius: 30px;
  font-size: 1.05rem;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 6px 16px rgba(63, 61, 123, 0.3);
  transition: all 0.3s ease;
}

.downloads-btn:hover {
  background: linear-gradient(to right, #3b3f9c, #5f4b8b);
  box-shadow: 0 8px 24px rgba(63, 61, 123, 0.5);
  transform: translateY(-2px);
}

/* Loading spinner styles */
.btn-loading {
    position: relative;
    pointer-events: none;
    opacity: 0.7;
}

.btn-loading .btn-text {
    opacity: 0;
}

.btn-loading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* Alternative loading dots animation */
.loading-dots::after {
    content: "";
    animation: loading-dots 1.5s infinite;
}

@keyframes loading-dots {
    0%, 20% { content: ""; }
    40% { content: "."; }
    60% { content: ".."; }
    80%, 100% { content: "..."; }
}

/* Download progress indicator */
.download-progress {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #007bff;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 1000;
    display: none;
}

.download-progress.show {
    display: block;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Button disabled state enhancement */
.downloads-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none !important;
}

.downloads-btn:disabled:hover {
    transform: none !important;
}



</style>
</head>
<body>
  <!-- ✅ EXTRACTED NAVBAR FROM PLASTICVISION -->
  <header class="header">
    <div class="nav-container">
      <div class="nav-content">
        <div class="logo">
          <div class="logo-icon">
            <img src="{{ url_for('static', filename='images/Eco_Spectra.png') }}" alt="logo" width="85px" height="70px">
          </div>
          <span class="logo-text"><a href="static\website (2)\website\index.html"  target="_blank" style="text-decoration: none;"><span class="Eco">Eco</span>Spectra</span></a>
        </div>
        
        <nav class="nav-menu">
          <a href="#technology" class="nav-link">Technology</a>
          <a href="#applications" class="nav-link">Applications</a>
          <a href="#contact" class="nav-link">Contact</a>
          <!-- <button class="btn btn-primary">Request Demo</button> -->
        </nav>
        
        <button class="mobile-menu-btn" id="mobileMenuBtn">
          <i data-lucide="menu"></i>
        </button>
      </div>
      
      <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-content">
          <a href="#technology" class="mobile-nav-link">Technology</a>
          <a href="#applications" class="mobile-nav-link">Applications</a>
          <a href="#contact" class="mobile-nav-link">Contact</a>
          <!-- <button class="btn btn-primary">Request Demo</button> -->
        </div>
      </div>
    </div>
  </header>

  <!-- Detailed Analysis Modal -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Detailed Analysis Report</h2>
        <button class="close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Results Header -->
    <div class="results-header">
      <h1>Results Analysis</h1>
<div class="results-summary">
  <div class="summary-stat">
    <strong>{{ results|length }}</strong> Files Processed
  </div>
  <div class="summary-stat">
    <strong>Elapsed Time:</strong> {{ elapsed_time }} seconds
  </div>

    </div>
    </div>

<div class="button-wrapper">
<button class="downloads-btn" onclick="downloadAllResults(this)">    
  <span class="btn-text">
        <i class="fas fa-download"></i> Download All Results
    </span>
  </button>
    

</div>
<!-- Results Grid --> 
<div class="results-grid">
  {% for res in results %}
  <div class="result-card">
    <div class="card-header">
      <h3 class="file-name">
        {{ res.filename }}
        {% if res.elapsed_time %}
          <span class="file-time">- Processing Time : {{ res.elapsed_time }} seconds</span>
        {% endif %}
      </h3>
      <button class="download-btn" onclick="downloadResults('{{ res.filename }}', this)" type="button">
        <span class="btn-text">
          <i class="fas fa-download"></i> Download Results
        </span>
      </button>
    </div>

          
          {% if res.predicted_class %}
            <!-- Summary for detected polymer -->
            <div class="summary-compact">
              <button class="details-btn" onclick="showDetails('{{ res.filename }}')">
                <i data-lucide="info" style="width: 16px; height: 16px;"></i>
                Details
              </button>
              <div><strong>{{ res.predicted_class }}</strong></div>
              <div>Confidence: <strong>{{ (res.confidence * 100) | round(1) }}%</strong></div>
              <div>Coverage: <strong>{{ (res.mask_coverage * 100) | round(1) }}%</strong></div>
            </div>
            
            <!-- NEW LAYOUT: Images row + Charts row -->
            <div class="content-layout">
              <!-- Images Row - 3 images in one line -->
              <div class="images-row">
                <div class="img-container">
                  <img src="{{ url_for('static', filename=res.original_image) }}" alt="Original image">
                  <div class="img-label">Original</div>
                </div>
                
                <div class="img-container">
                  <img src="{{ url_for('static', filename=res.ground_truth_image) }}" alt="Ground Truth overlay">
                  <div class="img-label">Ground Truth Overlay</div>
                </div>
                
                <div class="img-container">
                  <img src="{{ url_for('static', filename=res.overlay_image) }}" alt="Mask overlay">
                  <div class="img-label">Mask Overlay</div>
                </div>
              </div>
              
              <div class="charts-row">
                <!-- Probability Chart -->
                <div class="chart-container">
                  <canvas id="chart{{ loop.index }}"></canvas>
                </div>
                




              </div>

            </div>
            
            <script>
              // Probability Chart
              var ctx{{ loop.index }} = document.getElementById('chart{{ loop.index }}').getContext('2d');
              
              var labels{{ loop.index }} = JSON.parse('{{ res.class_names|tojson }}');
              var probs{{ loop.index }} = JSON.parse('{{ res.class_probs|tojson }}');
              
              var chart{{ loop.index }} = new Chart(ctx{{ loop.index }}, {
                type: 'bar',
                data: {
                  labels: labels{{ loop.index }},
                  datasets: [{
                    label: 'Classification Probability',
                    data: probs{{ loop.index }},
                    backgroundColor: [
                      'rgba(255, 99, 132, 0.7)',
                      'rgba(54, 162, 235, 0.7)',
                      'rgba(255, 205, 86, 0.7)',
                      'rgba(75, 192, 192, 0.7)',
                      'rgba(153, 102, 255, 0.7)',
                      'rgba(255, 159, 64, 0.7)',
                      'rgba(199, 199, 199, 0.7)',
                      'rgba(83, 102, 255, 0.7)'
                    ],
                    borderColor: [
                      'rgba(255, 99, 132, 1)',
                      'rgba(54, 162, 235, 1)',
                      'rgba(255, 205, 86, 1)',
                      'rgba(75, 192, 192, 1)',
                      'rgba(153, 102, 255, 1)',
                      'rgba(255, 159, 64, 1)',
                      'rgba(199, 199, 199, 1)',
                      'rgba(83, 102, 255, 1)'
                    ],
                    borderWidth: 2
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      display: false
                    },
                    title: {
                      display: true,
                      text: 'Polymer Classification Probabilities',
                      font: {
                        size: 16,
                        weight: 'bold'
                      }
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      max: 1,
                      title: {
                        display: true,
                        text: 'Probability',
                        font: {
                          size: 14
                        }
                      },
                      ticks: {
                        font: { size: 12 }
                      }
                    },
                    x: {
                      title: {
                        display: true,
                        text: 'Polymer Types',
                        font: {
                          size: 14
                        }
                      },
                      ticks: {
                        font: { size: 11 },
                        maxRotation: 45
                      }
                    }
                  }
                }
              });



              
            </script>


          {% endif %}
        </div>
      {% endfor %}
    </div>

    <!-- Back to upload link -->
    <a href="{{ url_for('index') }}" class="back-link" style="text-decoration:none;">Upload More Files</a>
  </div>

  <!-- JavaScript for modal and functionality -->
  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Mobile menu toggle
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');

    mobileMenuBtn.addEventListener('click', () => {
      mobileMenu.classList.toggle('show');
    });

    // Close mobile menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
        mobileMenu.classList.remove('show');
      }
    });

    // Modal functionality
    function showDetails(filename) {
      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      modalTitle.textContent = `Detailed Analysis: ${filename}`;
      modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 1.2em;">Loading detailed analysis...</div></div>';
      
      modal.style.display = 'block';
      
      // Fetch detailed analysis data
      fetch(`/get_detailed_analysis/${encodeURIComponent(filename)}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            modalBody.innerHTML = generateDetailedContent(data.analysis);
            
            // ADD THIS SPECTRUM CHART CODE HERE
            // Create spectrum chart if data is available
            if (data.analysis.spectrum_data) {
              setTimeout(() => {
                const ctx = document.getElementById('spectrumChart');
                if (ctx) {
                  new Chart(ctx, {
                    type: 'line',
                    data: {
                      labels: data.analysis.wavelengths || [],
                      datasets: [{
                        label: 'Reflectance',
                        data: data.analysis.spectrum_data || [],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4
                      }]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                        title: {
                          display: true,
                          text: 'Reflectance Spectrum',
                          font: {
                            size: 16,
                            weight: 'bold'
                          }
                        },
                        legend: {
                          display: false
                        }
                      },
                      scales: {
                        x: {
                          title: {
                            display: true,
                            text: 'Wavelength (nm)',
                            font: {
                              size: 14,
                              weight: 'bold'
                            }
                          },
                          grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                          }
                        },
                        y: {
                          title: {
                            display: true,
                            text: 'Reflectance',
                            font: {
                              size: 14,
                              weight: 'bold'
                            }
                          },
                          grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                          }
                        }
                      },
                      interaction: {
                        intersect: false,
                        mode: 'index'
                      }
                    }
                  });
                }
              }, 100);
            // CREATE SEGMENTATION PERFORMANCE CHART
            setTimeout(() => {
              const segCtx = document.getElementById('segmentationChart');
              if (segCtx) {
                // Extract performance metrics
                const performanceData = [
                  parseFloat(data.analysis.iou) || 0,
                  parseFloat(data.analysis.precision) || 0,
                  parseFloat(data.analysis.recall) || 0,
                  parseFloat(data.analysis.f1_score) || 0
                ];
                
                const performanceLabels = ['IoU Score', 'Precision', 'Recall', 'F1-Score'];
                
                new Chart(segCtx, {
                  type: 'bar',
                  data: {
                    labels: performanceLabels,
                    datasets: [{
                      label: 'Performance Metrics',
                      data: performanceData,
                      backgroundColor: [
                        'rgba(34, 197, 94, 0.7)',   // Green for IoU
                        'rgba(59, 130, 246, 0.7)',  // Blue for Precision
                        'rgba(245, 158, 11, 0.7)',  // Orange for Recall
                        'rgba(139, 92, 246, 0.7)'   // Purple for F1-Score
                      ],
                      borderColor: [
                        'rgba(34, 197, 94, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(139, 92, 246, 1)'
                      ],
                      borderWidth: 2
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: false
                      },
                      title: {
                        display: true,
                        text: 'Segmentation Performance Metrics',
                        font: {
                          size: 16,
                          weight: 'bold'
                        }
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        max: 1,
                        title: {
                          display: true,
                          text: 'Score',
                          font: {
                            size: 14,
                            weight: 'bold'
                          }
                        },
                        ticks: {
                          font: { size: 12 }
                        }
                      },
                      x: {
                        title: {
                          display: true,
                          text: 'Performance Metrics',
                          font: {
                            size: 14,
                            weight: 'bold'
                          }
                        },
                        ticks: {
                          font: { size: 12 }
                        }
                      }
                    }
                  }
                });
              }
            }, 150);

            }
            
          } else {
            modalBody.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc2626;"><div style="font-size: 1.2em;">Error loading analysis details</div><div style="margin-top: 10px;">${data.error}</div></div>`;
          }
        })
        .catch(error => {
          modalBody.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc2626;"><div style="font-size: 1.2em;">Error loading analysis details</div><div style="margin-top: 10px;">Network error occurred</div></div>';
        });
    }
            // <div class="detail-item">
            //   <div class="detail-label">Original File</div>
            //   <div class="detail-value">${analysis.original_file || 'N/A'}</div>
            // </div>
    function generateDetailedContent(analysis) {
      return `
        <!-- File Information Section -->
        <div class="detail-section">
          <h3><i data-lucide="file-text" style="width: 20px; height: 20px;"></i> File Information</h3>
          <div class="detail-grid">

            <div class="detail-item">
              <div class="detail-label">Image Dimensions</div>
              <div class="detail-value highlight-value">${analysis.image_dimensions || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Model Input Size</div>
              <div class="detail-value">${analysis.model_input_size || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Debris Polymer</div>
              <div class="detail-value highlight-value">${analysis.debris_polymer || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Debris Color</div>
              <div class="detail-value">${analysis.debris_color || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Background Flow Status</div>
              <div class="detail-value">${analysis.background_flow_status || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Plastic Fraction</div>
              <div class="detail-value highlight-value">${analysis.plastic_fraction || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Sediment Concentration</div>
              <div class="detail-value">${analysis.sediment_concentration || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Flow Discharge</div>
              <div class="detail-value">${analysis.flow_discharge || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Quality Flag</div>
              <div class="detail-value">${analysis.quality_flag || 'N/A'}</div>
            </div>
          </div>
        </div>

        <!-- Segmentation Results Section -->
        <div class="detail-section">
          <h3><i data-lucide="target" style="width: 20px; height: 20px;"></i> Segmentation Performance</h3>
          <div class="performance-metrics">
            <div class="metric-card">
              <div class="metric-value">${analysis.iou || 'N/A'}</div>
              <div class="metric-label">IoU Score</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">${analysis.precision || 'N/A'}</div>
              <div class="metric-label">Precision</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">${analysis.recall || 'N/A'}</div>
              <div class="metric-label">Recall</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">${analysis.f1_score || 'N/A'}</div>
              <div class="metric-label">F1-Score</div>
            </div>
          </div>

          <!-- ADD THIS SEGMENTATION PERFORMANCE CHART SECTION -->
          <div style="margin-top: 25px;">
            <h4 style="margin-bottom: 15px; color: #374151;">Performance Metrics Chart:</h4>
            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
              <canvas id="segmentationChart" width="800" height="400"></canvas>
            </div>
          </div>
          
          <div class="detail-grid" style="margin-top: 20px;">

          <div class="detail-grid" style="margin-top: 20px;">
            <div class="detail-item">
              <div class="detail-label">Polymer Pixels Detected</div>
              <div class="detail-value highlight-value">${analysis.polymer_detected_pixels || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Coverage</div>
              <div class="detail-value highlight-value">${analysis.coverage || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Ground Truth Coverage</div>
              <div class="detail-value">${analysis.ground_truth_coverage || 'N/A'}</div>
            </div>
          </div>
        </div>

        <!-- Classification Results Section -->
        <div class="detail-section">
          <h3><i data-lucide="brain" style="width: 20px; height: 20px;"></i> Classification Results</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Predicted Polymer Type</div>
              <div class="detail-value highlight-value">${analysis.predicted_polymer_type || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Confidence</div>
              <div class="detail-value highlight-value">${analysis.confidence || 'N/A'}</div>
            </div>
          </div>
          ${analysis.class_probabilities ? `
          <div style="margin-top: 20px;">
            <h4 style="margin-bottom: 15px; color: #374151;">Class Probabilities:</h4>
            <div class="detail-grid">
              ${Object.entries(analysis.class_probabilities).map(([polymer, prob]) => `
                <div class="detail-item">
                  <div class="detail-label">${polymer}</div>
                  <div class="detail-value">${prob}</div>
                </div>
              `).join('')}
            </div>
          </div>
          ` : ''}
        </div>

        <!-- Spectral Information Section -->
        <div class="detail-section">
          <h3><i data-lucide="activity" style="width: 20px; height: 20px;"></i> Spectral Information</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Reflectance Spectrum Bands</div>
              <div class="detail-value highlight-value">${analysis.reflectance_spectrum_bands || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Wavelength Range</div>
              <div class="detail-value">${analysis.wavelength_range || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Spectrum Range</div>
              <div class="detail-value">${analysis.spectrum_range || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Mean Reflectance</div>
              <div class="detail-value highlight-value">${analysis.mean_reflectance || 'N/A'}</div>
            </div>
          </div>
          
          <!-- ADD THIS SPECTRUM CHART SECTION -->
          ${analysis.spectrum_data ? `
          <div style="margin-top: 25px;">
            <h4 style="margin-bottom: 15px; color: #374151;">Reflectance Spectrum:</h4>
            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
              <canvas id="spectrumChart" width="800" height="400"></canvas>
            </div>
          </div>
          ` : ''}
        </div>
      `;
    }

    function closeModal() {
      document.getElementById('detailModal').style.display = 'none';
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('detailModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeModal();
      }
    });

    // Re-initialize Lucide icons after modal content is loaded
    document.addEventListener('DOMContentLoaded', function() {
      lucide.createIcons();
    });

// ── HELPER: find a .result-card by matching its <h3 class="file-name">…</h3> exactly ──
function findCardByFilename(filename) {
  return Array.from(document.querySelectorAll('.result-card')).find(card => {
    const nameEl = card.querySelector('.file-name');
  return nameEl && nameEl.textContent.trim().startsWith(filename);
  });
}

// ── 1) INDIVIDUAL DOWNLOAD ──
async function downloadResults(filename, buttonElement) {
    // Add loading state to button
    buttonElement.classList.add('btn-loading');
    const originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = '<span class="btn-text">Preparing Download...</span>';
    
    try {
        const card = findCardByFilename(filename);
        if (!card) {
            console.error(`No result-card found for filename="${filename}"`);
            return;
        }
        
        const zip = new JSZip();
        const reportsFolder = zip.folder('reports');
        const screenshotsFolder = zip.folder('screenshots');
        const imagesFolder = zip.folder('images');
        
        // Fetch report text from /download_report/<filename>
        try {
            const resp = await fetch(`/download_report/${encodeURIComponent(filename)}`);
            if (resp.ok) {
                const text = await resp.text();
                const base = filename.endsWith('.nc4') ? filename.slice(0, -4) : filename;
                reportsFolder.file(`${base}.txt`, text);
            } else {
                console.warn(`Report endpoint returned ${resp.status} for "${filename}"`);
            }
        } catch (err) {
            console.error(`Error fetching report for "${filename}":`, err);
        }
        
        // Capture screenshot of this entire card
        try {
            const canvas = await html2canvas(card, { useCORS: true, backgroundColor: '#ffffff' });
            const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
            const base = filename.endsWith('.nc4') ? filename.slice(0, -4) : filename;
            screenshotsFolder.file(`${base}-card.png`, blob);
        } catch (err) {
            console.error(`Error capturing screenshot for "${filename}":`, err);
        }
        
        // Capture screenshot of the reflectance spectrum from modal
        try {
            // Find and click the details button to open the modal
            const detailsButton = card.querySelector('.details-btn');
            
            if (detailsButton) {
                // Click the details button to open modal
                detailsButton.click();
                
                // Wait for modal to open and chart to render
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Find the spectrum chart by its ID
                const spectrumChart = document.getElementById('spectrumChart');
                
                if (spectrumChart) {
                    // Get the canvas element from Chart.js
                    const chartCanvas = spectrumChart.querySelector('canvas') || spectrumChart;
                    
                    if (chartCanvas && chartCanvas.tagName === 'CANVAS') {
                        // For Chart.js canvas, we can directly convert to blob
                        const blob = await new Promise(resolve => {
                            chartCanvas.toBlob(resolve, 'image/png');
                        });
                        
                        const base = filename.endsWith('.nc4') ? filename.slice(0, -4) : filename;
                        screenshotsFolder.file(`${base}-spectrum.png`, blob);
                    } else {
                        // Fallback to html2canvas if direct canvas access fails
                        const canvas = await html2canvas(spectrumChart, { 
                            useCORS: true, 
                            backgroundColor: '#ffffff',
                            scale: 2,
                            logging: false
                        });
                        const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
                        const base = filename.endsWith('.nc4') ? filename.slice(0, -4) : filename;
                        screenshotsFolder.file(`${base}-spectrum.png`, blob);
                    }
                } else {
                    console.warn(`Spectrum chart with ID 'spectrumChart' not found for "${filename}"`);
                }
                
                // Close the modal
                const modal = document.getElementById('detailModal');

                
                if (modal) {
                    const closeButton = modal.querySelector('.btn-close') ||
                                      modal.querySelector('.close') ||
                                      modal.querySelector('[data-dismiss="modal"]');
                    if (closeButton) {
                        closeButton.click();
                    }
                }
            } else {
                console.warn(`Details button not found for "${filename}"`);
            }
        } catch (err) {
            console.error(`Error capturing spectrum screenshot for "${filename}":`, err);
        }
        
        // Fetch the three images under this card (Original, Ground Truth, Mask)
        const imgs = card.querySelectorAll('.img-container img');
        if (imgs.length >= 3) {
            const [origImg, groundImg, maskImg] = imgs;
            
            async function fetchImageBlob(src) {
                try {
                    if (src.startsWith('data:')) {
                        const [header, base64] = src.split(',');
                        const mime = header.match(/:(.*?);/)[1];
                        const binary = atob(base64);
                        const arr = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) {
                            arr[i] = binary.charCodeAt(i);
                        }
                        return new Blob([arr], { type: mime });
                    } else {
                        const r = await fetch(src);
                        return r.ok ? await r.blob() : null;
                    }
                } catch {
                    return null;
                }
            }
            
            try {
                const [b1, b2, b3] = await Promise.all([
                    fetchImageBlob(origImg.src),
                    fetchImageBlob(groundImg.src),
                    fetchImageBlob(maskImg.src)
                ]);
                const base = filename.endsWith('.nc4') ? filename.slice(0, -4) : filename;
                if (b1) imagesFolder.file(`${base}-original.png`, b1);
                if (b2) imagesFolder.file(`${base}-groundtruth.png`, b2);
                if (b3) imagesFolder.file(`${base}-mask.png`, b3);
            } catch (err) {
                console.error(`Error fetching images for "${filename}":`, err);
            }
        } else {
            console.warn(`Card for "${filename}" has ${imgs.length} images (expected ≥3).`);
        }
        
        // Generate and save the ZIP
        const blob = await zip.generateAsync({ type: 'blob' });
        const base = filename.endsWith('.nc4') ? filename.slice(0, -4) : filename;
        saveAs(blob, `${base}_results.zip`);
        
    } catch (err) {
        console.error(`Error generating ZIP for "${filename}":`, err);
    } finally {
        // Reset button state
        buttonElement.classList.remove('btn-loading');
        buttonElement.innerHTML = originalText;
    }
}


function captureResultScreenshots(resultCard, filename) {
  // You'll need to include html2canvas library
  if (typeof html2canvas === 'undefined') {
    console.error('html2canvas library not loaded');
    return;
  }

  // Capture the entire result card
  html2canvas(resultCard, {
    scale: 2,
    useCORS: true,
    allowTaint: true,
    backgroundColor: '#ffffff'
  }).then(canvas => {
    // Download the screenshot
    const link = document.createElement('a');
    link.download = `${filename.split('.')[0]}_results_screenshot.png`;
    link.href = canvas.toDataURL();
    link.click();
  }).catch(error => {
    console.error('Error capturing screenshot:', error);
  });
}

// BULK DOWNLOAD: iterate all .result-card elements, fetch their reports, screenshots, and images
// ── 2) DOWNLOAD ALL ──
async function downloadAllResults(buttonElement) {
    // Add loading state to button
    buttonElement.classList.add('btn-loading');
    const originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = '<span class="btn-text">Preparing Download...</span>';

    try {
        const zip = new JSZip();
        const reportsFolder = zip.folder('reports');
        const screenshotsFolder = zip.folder('screenshots');
        const imagesFolder = zip.folder('images');
        const cards = document.querySelectorAll('.result-card');

        for (let card of cards) {
            const nameEl = card.querySelector('.file-name');
            if (!nameEl) continue;

            // 🟢 Extract clean filename (remove " - Processing Time...")
            let filename = nameEl.textContent.trim().split("-")[0].trim();
            const base = filename.endsWith('.nc4') ? filename.slice(0, -4) : filename;

            // === Fetch report ===
            try {
                const resp = await fetch(`/download_report/${encodeURIComponent(filename)}`);
                if (resp.ok) {
                    const text = await resp.text();
                    reportsFolder.file(`${base}.txt`, text);
                } else {
                    console.warn(`Report not found for ${filename}`);
                }
            } catch (err) {
                console.error(`Error fetching report for "${filename}":`, err);
            }

            // === Screenshot of result card ===
            try {
                const canvas = await html2canvas(card, { useCORS: true, backgroundColor: '#ffffff' });
                const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
                screenshotsFolder.file(`${base}-card.png`, blob);
            } catch (err) {
                console.error(`Screenshot failed for "${filename}":`, err);
            }

            // === Spectrum chart from modal ===
            try {
                const detailsButton = card.querySelector('.details-btn');
                if (detailsButton) {
                    detailsButton.click();
                    await new Promise(resolve => setTimeout(resolve, 1500)); // wait for chart to load

                    const spectrumChart = document.getElementById('spectrumChart');
                    if (spectrumChart) {
                        const chartCanvas = spectrumChart.querySelector('canvas') || spectrumChart;
                        let blob;

                        if (chartCanvas && chartCanvas.tagName === 'CANVAS') {
                            blob = await new Promise(resolve => chartCanvas.toBlob(resolve, 'image/png'));
                        } else {
                            const canvas = await html2canvas(spectrumChart, { 
                                useCORS: true, 
                                backgroundColor: '#ffffff',
                                scale: 2 
                            });
                            blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
                        }

                        if (blob) screenshotsFolder.file(`${base}-spectrum.png`, blob);
                    }

                    // Close modal safely
                    const modal = document.getElementById('detailModal');
                    if (modal) {
                        const closeButton = modal.querySelector('.close');
                        if (closeButton) closeButton.click();
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            } catch (err) {
                console.error(`Error capturing spectrum screenshot for "${filename}":`, err);
            }

            // === Fetch associated images ===
            const imgs = card.querySelectorAll('.img-container img');
            if (imgs.length >= 3) {
                const [origImg, groundImg, maskImg] = imgs;

                async function fetchImageBlob(src) {
                    try {
                        const r = await fetch(src);
                        return r.ok ? await r.blob() : null;
                    } catch {
                        return null;
                    }
                }

                try {
                    const [b1, b2, b3] = await Promise.all([
                        fetchImageBlob(origImg.src),
                        fetchImageBlob(groundImg.src),
                        fetchImageBlob(maskImg.src)
                    ]);
                    if (b1) imagesFolder.file(`${base}-original.png`, b1);
                    if (b2) imagesFolder.file(`${base}-groundtruth.png`, b2);
                    if (b3) imagesFolder.file(`${base}-mask.png`, b3);
                } catch (err) {
                    console.error(`Error fetching images for "${filename}":`, err);
                }
            }
        }

        // === Generate final ZIP ===
        const blob = await zip.generateAsync({ type: 'blob' });
        saveAs(blob, 'all_results.zip');

    } catch (err) {
        console.error('Error generating combined ZIP:', err);
    } finally {
        buttonElement.classList.remove('btn-loading');
        buttonElement.innerHTML = originalText;
    }
}






function base64ToBlob(base64, contentType) {
    const byteCharacters = atob(base64);
    const byteArrays = [];
    
    for (let offset = 0; offset < byteCharacters.length; offset += 512) {
        const slice = byteCharacters.slice(offset, offset + 512);
        const byteNumbers = new Array(slice.length);
        
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }
    
    return new Blob(byteArrays, {type: contentType});
}

function showNotification(message, type = 'info') {
    // Remove any existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="notification-icon ${getNotificationIcon(type)}"></i>
            <span class="notification-message">${message}</span>
            <button class="notification-close" onclick="this.closest('.notification').remove()">&times;</button>
        </div>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.add('notification-show');
    }, 10);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.remove('notification-show');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }
    }, 5000);
}

function getNotificationIcon(type) {
    switch(type) {
        case 'success':
            return 'fas fa-check-circle';
        case 'error':
            return 'fas fa-exclamation-circle';
        case 'warning':
            return 'fas fa-exclamation-triangle';
        default:
            return 'fas fa-info-circle';
    }
}

// Optional: Add function to manually clear all notifications
function clearNotifications() {
    const notifications = document.querySelectorAll('.notification');
    notifications.forEach(notification => {
        notification.classList.remove('notification-show');
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 300);
    });
}



  </script>
</body>
</html>
